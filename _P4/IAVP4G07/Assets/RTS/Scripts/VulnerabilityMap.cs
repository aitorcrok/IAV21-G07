using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace es.ucm.fdi.iav.rts
{
    public class VulnerabilityMap : GraphGrid
    {
        private TensionMap tensionMap;
        private InfluenceMap influenceMap;
        public VertexInfluence[] influences;

        // works as vertices in regular graph
        // GameObject[] locations;

        void Awake()
        {
            tensionMap = GetComponent<TensionMap>();
            influenceMap = GetComponent<InfluenceMap>();
            influences = new VertexInfluence[GetRows() * GetCols()];

        }
        public void ComputeInfluence()
        {
            VertexInfluence[] tensionVertex = tensionMap.influences;
            VertexInfluence[] influenceVertex = influenceMap.influences;
            foreach (VertexInfluence ver in influences)
            {
                ver.value = 0;
            }

            for (int i = 0; i < GetRows(); i++)
            {
                for (int j = 0; j < GetCols(); j++)
                {
                    int id = GridToId(j, i);

                    VertexInfluence tensionVertice = tensionVertex[id];
                    VertexInfluence influenceVertice = influenceVertex[id];

                    influences[id].value = tensionVertice.value - Mathf.Abs(influenceVertice.value);
                    float value = influences[id].value;

                    Color mycolor;

                    if (value > 0) mycolor = Color.blue;
                    else if (value < 0) mycolor = Color.red;
                    else mycolor = Color.white;

                    mycolor.a = value;

                    GetVertexObj(id).GetComponent<MeshRenderer>().material.color = mycolor;
                }
            }
        }

        public Transform GetMostVulnerable(out float value)
        {
            float max = -1;
            Transform pos = null;
            for (int i = 0; i < GetRows(); i++)
            {
                for (int j = 0; j < GetCols(); j++)
                {
                    int id = GridToId(j, i);

                    VertexInfluence vertex = vertices[id] as VertexInfluence;
                    if (vertex.value > max)
                    {
                        max = vertex.value;
                        pos = vertex.transform;
                    }
                }
            }

            value = max;
            return pos;
        }
    }
}